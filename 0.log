    
  013 PRODUCTOS AJENOS 029 PRECOCINADOS AJENOS  
    descripción de presentacion  190    AROS    187 TORTELLI
    Nombre común:                396   CEBOLLA  389 CECINA

let
    Origen = Odbc.Query("dsn=LIBRA", "
    SELECT v.NUMERO_ALBARAN || ' ALBARAN' AS NUMERO_ALBARAN, 
    'Núm de fact ' || v.NUMERO_FACTURA || '; Fecha ped ' || TO_CHAR(v.FECHA_PEDIDO, 'DD/MM/YYYY') AS NUMERO_FACTURA,
    v.ORGANIZACION_COMERCIAL,
    AG_T.CODIGO || ' ' || AG_T.NOMBRE AS AGENTE_SUZ,
    v.CLIENTE || ' '  || c.NOMBRE AS CLIENTE_SUZ,
    v.FECHA_PEDIDO, 
    TO_NUMBER(v.PRECIO_UND_CONSUMO) AS PRECIO_UND_CONSUMO, 
    TO_NUMBER(v.UNI_SERALM) AS UNI_SERALM,
    TO_NUMBER(v.IMPORTE_NETO_LIN_AJUS) AS IMPORTE_NETO_LIN_AJUS,
    TO_NUMBER(v.IMPORTE_NETO_LIN_AJUS_FF) AS IMPORTE_NETO_LIN_AJUS_FF, 
    v.ARTICULO || ' ' || v.DESCRIPCION_ARTICULO AS ARTICULO_DESCRIPCION_SUZ,
    c.LISTA_PRECIOS,
    (SELECT MAX(p.FECHA_VALIDEZ)    -- Subconsulta para obtener la FECHA_VALIDEZ más reciente 
     FROM PRECIOS_LISTAS p 
     WHERE p.CODIGO_ARTICULO = v.ARTICULO
        AND p.ORGANIZACION_COMERCIAL = v.ORGANIZACION_COMERCIAL
        AND p.NUMERO_LISTA = c.LISTA_PRECIOS
        AND p.FECHA_VALIDEZ <= v.FECHA_PEDIDO) AS FECHA_VALIDEZ,
    TO_NUMBER((SELECT p.PRECIO_CONSUMO        -- Subconsulta para obtener el PRECIO_CONSUMO correspondiente a la FECHA_VALIDEZ más reciente
     FROM PRECIOS_LISTAS p 
     WHERE p.CODIGO_ARTICULO = v.ARTICULO 
     AND p.NUMERO_LISTA = c.LISTA_PRECIOS
     AND p.ORGANIZACION_COMERCIAL = v.ORGANIZACION_COMERCIAL
     AND p.FECHA_VALIDEZ <= v.FECHA_PEDIDO 
     ORDER BY p.FECHA_VALIDEZ DESC
     FETCH FIRST 1 ROW ONLY  -- Garantiza que solo devuelva un resultado
    )) AS PRECIO_CONSUMO,
     TO_NUMBER((SELECT pc.PRECIO_CONSUMO        -- PRECIOS ESPECIALES
     FROM PRECIOS_CLIENTES pc 
     WHERE pc.CODIGO_ARTICULO = v.ARTICULO
     AND pc.ORGANIZACION_COMERCIAL = v.ORGANIZACION_COMERCIAL
     AND pc.CODIGO_CLIENTE = v.CLIENTE
     AND pc.FECHA_VALIDEZ <= v.FECHA_PEDIDO 
     ORDER BY pc.FECHA_VALIDEZ DESC
     FETCH FIRST 1 ROW ONLY
    )) AS PRECIOS_ESPECIALES,

    TO_NUMBER((SELECT oferta.PRECIO          -- PRECIO OFERTA
     FROM OFERTAS_ART_CLI oferta
     WHERE oferta.CODIGO_ARTICULO = v.ARTICULO
        AND oferta.CODIGO_CLIENTE = v.CLIENTE
        AND oferta.ORGANIZACION_COMERCIAL = v.ORGANIZACION_COMERCIAL
        AND oferta.FECHA_VALIDEZ <= v.FECHA_PEDIDO AND oferta.FECHA_OFERTA >= v.FECHA_PEDIDO
        ORDER BY oferta.FECHA_VALIDEZ DESC
     FETCH FIRST 1 ROW ONLY
    )) AS PRECIO_OFERTA,

   -- Determinar PRECIO_LISTADO_FINAL directamente en el CASE
    CASE 
        WHEN(SELECT TO_NUMBER(oferta.PRECIO)          -- PRECIO OFERTA
             FROM OFERTAS_ART_CLI oferta
             WHERE oferta.CODIGO_ARTICULO = v.ARTICULO
                AND oferta.CODIGO_CLIENTE = v.CLIENTE
                AND oferta.ORGANIZACION_COMERCIAL = v.ORGANIZACION_COMERCIAL
                AND oferta.FECHA_VALIDEZ <= v.FECHA_PEDIDO AND oferta.FECHA_OFERTA >= v.FECHA_PEDIDO
                ORDER BY oferta.FECHA_VALIDEZ DESC
             FETCH FIRST 1 ROW ONLY) > 0
        THEN (SELECT TO_NUMBER(oferta.PRECIO)          -- PRECIO OFERTA
              FROM OFERTAS_ART_CLI oferta
              WHERE oferta.CODIGO_ARTICULO = v.ARTICULO
                AND oferta.CODIGO_CLIENTE = v.CLIENTE
                AND oferta.ORGANIZACION_COMERCIAL = v.ORGANIZACION_COMERCIAL
                AND oferta.FECHA_VALIDEZ <= v.FECHA_PEDIDO AND oferta.FECHA_OFERTA >= v.FECHA_PEDIDO
                ORDER BY oferta.FECHA_VALIDEZ DESC
                FETCH FIRST 1 ROW ONLY
        )

        WHEN (SELECT TO_NUMBER(pc.PRECIO_CONSUMO)
              FROM PRECIOS_CLIENTES pc 
              WHERE pc.CODIGO_ARTICULO = v.ARTICULO
              AND pc.ORGANIZACION_COMERCIAL = v.ORGANIZACION_COMERCIAL
              AND pc.CODIGO_CLIENTE = v.CLIENTE
              AND pc.FECHA_VALIDEZ <= v.FECHA_PEDIDO 
              ORDER BY pc.FECHA_VALIDEZ DESC
              FETCH FIRST 1 ROW ONLY
        ) > 0 
        THEN (SELECT TO_NUMBER(pc.PRECIO_CONSUMO)
              FROM PRECIOS_CLIENTES pc 
              WHERE pc.CODIGO_ARTICULO = v.ARTICULO
              AND pc.ORGANIZACION_COMERCIAL = v.ORGANIZACION_COMERCIAL
              AND pc.CODIGO_CLIENTE = v.CLIENTE
              AND pc.FECHA_VALIDEZ <= v.FECHA_PEDIDO 
              ORDER BY pc.FECHA_VALIDEZ DESC
              FETCH FIRST 1 ROW ONLY
        )
        ELSE (SELECT TO_NUMBER(p.PRECIO_CONSUMO)        
                  FROM PRECIOS_LISTAS p 
                  WHERE p.CODIGO_ARTICULO = v.ARTICULO 
                  AND p.NUMERO_LISTA = c.LISTA_PRECIOS
                  AND p.ORGANIZACION_COMERCIAL = v.ORGANIZACION_COMERCIAL
                  AND p.FECHA_VALIDEZ <= v.FECHA_PEDIDO 
                  ORDER BY p.FECHA_VALIDEZ DESC
                  FETCH FIRST 1 ROW ONLY
        )
    END AS PRECIO_LISTADO_FINAL
FROM V_BI_VENTAS v
JOIN VA_CLIENTES c ON v.CLIENTE = c.CODIGO_RAPIDO
JOIN AGENTES_CLIENTES AGENTE_CL ON v.EMPRESA = AGENTE_CL.EMPRESA AND v.CLIENTE = AGENTE_CL.CODIGO_CLIENTE
JOIN ARTICULOS ART ON v.EMPRESA = ART.CODIGO_EMPRESA AND v.ARTICULO = ART.CODIGO_ARTICULO
JOIN AGENTES AG_T ON AG_T.CODIGO = AGENTE_CL.AGENTE
WHERE  v.ORGANIZACION_COMERCIAL IN ('01', '03', '04')
    AND v.FECHA_PEDIDO >= TO_DATE('2025-03-01', 'YYYY-MM-DD')
    AND AGENTE_CL.RESPONSABLE_CLIENTES = 'S'
    AND v.STATUS_ALBARAN NOT IN ('1900')  -- para quitar muestras
    AND ART.CODIGO_FAMILIA NOT IN ('090') -- 090 NO POWER BI
    AND ART.CODIGO_ESTAD7 NOT IN ('020')  -- el material auxiliar NO SE VENDE
    AND ART.TIPO_MATERIAL NOT IN ('T')")
in
    Origen



= Odbc.Query("
    
    dsn=LIBRA", "
  SELECT A.EMPRESA,
       A.ORGANIZACION_COMERCIAL,
       A.NUMERO_SERIE,
       A.NUMERO_ALBARAN,
       A.EJERCICIO,
       A.SUB_ALBARAN,
       ALMACEN,
       NUMERO_FACTURA,
       NUMERO_SERIE_FRA,
       EJERCICIO_FACTURA,
       A.CENTRO_CONTABLE,
       CLIENTE,
       CASE
            WHEN A.ORGANIZACION_COMERCIAL = '02' THEN B.AGENTE
            ELSE (
                        SELECT AGENTE
                        FROM ALBARAN_AGENTES Z
                        WHERE  A.NUMERO_ALBARAN = Z.NUMERO_ALBARAN
                        AND A.NUMERO_SERIE = Z.NUMERO_SERIE
                        AND A.EJERCICIO = Z.EJERCICIO
                        AND A.SUB_ALBARAN = Z.SUB_ALBARAN
                        AND A.ORGANIZACION_COMERCIAL = Z.ORGANIZACION_COMERCIAL
                        AND A.EMPRESA = Z.EMPRESA
                        )
        END AGENTE, -- SI EL MERCADO ES REGIONAL SE TRAE EL AGENTE PRINCIPAL SI NO SE TRAE EN AGENTE QUE HIZO LA VENTA,
       A.TIPO_PEDIDO,
       FECHA_PEDIDO,
       STATUS_ALBARAN,
       FORMA_PAGO,
       DIVISA,
       TO_NUMBER(COSTE_BRUTO) AS COSTE_BRUTO,
       TO_NUMBER(IMPORTE_BRUTO) AS IMPORTE_BRUTO,
       TO_NUMBER(A.PESO_BRUTO) AS PESO_BRUTO,
       ARTICULO,
       DESCRIPCION_ARTICULO,
       A.TIPO_CADENA_LOGISTICA,
       TIPO_UNIDAD_CADENA_LOGISTICA,
       PRESENTACION_PEDIDO,
       TO_NUMBER(CANTIDAD_PEDIDA) AS CANTIDAD_PEDIDA,
       TO_NUMBER(PRECIO_PRESENTACION) AS PRECIO_PRESENTACION,
       TO_NUMBER(UNIDADES_SERVIDAS) AS UNIDADES_SERVIDAS,
       CODIGO_ZONA,
       TIPO_MOVIMIENTO,
       TO_NUMBER(IMPORTE_NETO_LIN_AJUS) AS IMPORTE_NETO_LIN_AJUS,
       TO_NUMBER(IMPORTE_NETO_LIN_AJUS_FF) AS IMPORTE_NETO_LIN_AJUS_FF,
       TO_NUMBER(IMPORTE_NETO_LIN) AS IMPORTE_NETO_LIN,
       TO_NUMBER(IMPORTE_BRUTO_LIN) AS IMPORTE_BRUTO_LIN,
       TO_NUMBER(COSTE_BRUTO_LIN) AS COSTE_BRUTO_LIN,
       TO_NUMBER(UNI_PEDALM) AS UNI_PEDALM,
       TO_NUMBER(UNI_SERALM) AS UNI_SERALM,
       TO_NUMBER(UNI_PEDALM2) AS UNI_PEDALM2,
       TO_NUMBER(UNI_SERALM2) AS UNI_SERALM2,
       TO_NUMBER(UNI_PEDDIS) AS UNI_PEDDIS,
       TO_NUMBER(UNI_PEDSOB) AS UNI_PEDSOB,
       TO_NUMBER(UNI_PEDSUB) AS UNI_PEDSUB,
       TO_NUMBER(UNI_PEDCON) AS UNI_PEDCON,
       TO_NUMBER(UNI_SERSOB) AS UNI_SERSOB,
       TO_NUMBER(UNI_SERSUB) AS UNI_SERSUB,
       TO_NUMBER(UNI_SERCON) AS UNI_SERCON,
       C.CODIGO_FAMILIA AS CODIGO_ESTAD1,
       C.CODIGO_ESTAD2,
       C.CODIGO_ESTAD3,
       C.CODIGO_ESTAD4,
       C.CODIGO_ESTAD5,
       C.CODIGO_ESTAD6,
       C.CODIGO_ESTAD7,
       TO_NUMBER(COSTE_MAS_GASTOS) AS COSTE_MAS_GASTOS,
       TO_NUMBER(IMPORTE_NETO_LIN_AJUS_CONTA) AS IMPORTE_NETO_LIN_AJUS_CONTA,
       A.ARTICULO || '_' || A.EMPRESA AS PRIMARY_KEY_ARTICULO,
       C.CODIGO_FAMILIA || '_' || A.EMPRESA AS PRIMARY_KEY_FAMILIA,
       C.CODIGO_ESTAD2 || '_' || A.EMPRESA AS PRIMARY_KEY_SUBFAMILIA,
       C.CODIGO_ESTAD3 || '_' || A.EMPRESA AS PRIMARY_KEY_CLASIFICACION,
       C.CODIGO_ESTAD4 || '_' || A.EMPRESA AS PRIMARY_KEY_PRESENTACION,
       C.CODIGO_ESTAD5 || '_' || A.EMPRESA AS PRIMARY_KEY_NOMBRE_COMUN,
       C.CODIGO_ESTAD6 || '_' || A.EMPRESA AS PRIMARY_KEY_PROPIEDAD_DESTINO,
       C.CODIGO_ESTAD7 || '_' || A.EMPRESA AS PRIMARY_KEY_TIPO_MATERIAL,
       A.ALMACEN || '_' || A.EMPRESA AS PRIMARY_KEY_ALMACEN,
       B.AGENTE || '_' || A.EMPRESA AS PRIMARY_KEY_AGENTE,
       -- CODIGO_ESTADO AS PRIMARY_KEY_ESTADOS,
       -- A.ESTADO || '_' || A.PROVINCIA AS PRIMARY_KEY_PROVINCIA,
       A.CENTRO_CONTABLE || '_' || A.EMPRESA AS PRIMARY_KEY_CENTRO_CONTABLE,
       A.CLIENTE || '_' || A.EMPRESA AS PRIMARY_KEY_CLIENTE,
       A.TIPO_MOVIMIENTO AS PRIMARY_KEY_TIP_MOVIMIENTO,
       A.ORGANIZACION_COMERCIAL || '_' || A.EMPRESA AS PRIMERY_KEY_ORG_COMERCIAL,
       A.CODIGO_ZONA || '_' || ALMACEN || '_' || A.EMPRESA AS PRIMARY_KEY_ALM_ZONA,
       C.TIPO_MATERIAL 
FROM V_BI_VENTAS A
JOIN AGENTES_CLIENTES B
        ON A.EMPRESA = B.EMPRESA
        AND A.CLIENTE = B.CODIGO_CLIENTE
JOIN ARTICULOS C
         ON A.EMPRESA = C.CODIGO_EMPRESA
        AND A.ARTICULO = C.CODIGO_ARTICULO 
WHERE A.EJERCICIO >= EXTRACT(YEAR FROM SYSDATE) - 2
AND B.RESPONSABLE_CLIENTES = 'S'
--AND C.TIPO_MATERIAL NOT IN ('T') --para quitar los rappels y genericos(ART TIPO TEXTO) comentado a solicitud de JUAN 
AND C.CODIGO_FAMILIA NOT IN ('090') --090 NO POWER BI
AND A.STATUS_ALBARAN NOT IN ('1900') --para quitar muestras
AND C.CODIGO_ESTAD7 NOT IN ('020') --el material auxiliar NO SE VENDE












    
    
    ")